---
title       : Inputs for optimization
description : For optimizing the portfolio investment decisions and understanding the sources of performance and risk, it is crucial to understand the multivariate nature of the return distribution of the risky assets.  In this chapter, you learn how to estimate the vector of expected return and the covariance matrix and to connect them to the portfolio return distribution.  

--- type:MultipleChoiceExercise lang:r xp:50 skills:1   key:27fc122215
## The sources of portfolio performance

Chapter 2 introduced you to the *univariate* approach of analyzing portfolio performance based on a statistical analysis of the portfolio return series. In this chapter, we consider a *multivariate* analysis and study how the portfolio performance is affected by the interaction between the performance of the individual portfolio positions. 

As a motivating example, let us consider a portfolio invested in two very diverse exchange traded funds (ETFs), namely an ETF tracking the broad US equities market (ETF with symbol SPY) and an ETF track the US bonds market (ETF with symbol AGG). The monthly returns for these ETFs and the 60/40 portfolio that invests every month 60% in the equities ETF and 40% in the bonds ETF are available in the workspace as `returns_bonds`, `returns_equities` and `returns_6040`.   

Verify in the R-console which of the following statements is false. 


*** =instructions
- A portfolio is less volatile than the sum of its component volatilities. This implies that the standard deviation of the 60/40 portfolio is less than `0.6*sd(returns_equities)+0.4*sd(returns_bonds)`. We call this the subadditivity property of the standard deviation.    
- The portfolio mean return equals the sum of the component average returns, that is, `mean(returns_6040)==0.6*mean(returns_equities)+0.4*mean(returns_bonds)`.  
- None of the above statements is correct. 

*** =hint
hint

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
library(PerformanceAnalytics)
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
eq_prices <- get.hist.quote(instrument="SPY",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
bond_prices <- get.hist.quote(instrument="AGG",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
eq_prices <- eq_prices/as.numeric(eq_prices[1])
bond_prices <-  bond_prices/as.numeric(bond_prices[1])

### plot
weights <- c(0.6,0.4)
prices <- cbind(eq_prices,bond_prices)
returns <- CalculateReturns(prices)
returns <- returns[(-1),]
returns_6040 <- Return.portfolio(returns, weights,rebalance_on="months")
# check: all.equal( as.numeric(returns_6040),as.numeric(0.6*returns[,1]+0.4*returns[,2])  )
prices_6040 <- zoo(cumprod(1+returns_6040),order.by=time(returns_6040))
temp <- c( as.numeric(eq_prices), as.numeric(bond_prices) )
ylim <- c( min( temp ) , max(temp) )
plot.zoo(eq_prices , main="Equity-bond portfolios",ylab="", xlab="",ylim=ylim)
lines(bond_prices,col="red")
lines(prices_6040,col="blue")
legend("topleft", legend=c("Equities (ticker: SPY)","Bonds (ticker: AGG)","60/40 Equities-Bonds") , col=c("black","red","blue") , lwd = 1 )

###
newdates <- seq(as.Date(time(bond_prices ))[2], length=nrow(bond_prices ), by="1 month") - 2
eq_prices <- xts(eq_prices,newdates)
bond_prices <- xts(bond_prices,newdates)
prices <- cbind(eq_prices,bond_prices)
colnames(prices) <- c("equities","bonds")
# calculate returns
returns <- CalculateReturns(prices)
returns <- returns[(-1),]
returns_bonds <- returns$bonds
returns_equities <- returns$equities
```

*** =sct
```{r}
test_mc(3) # if 3 is the correct option.
```

--- type:NormalExercise lang:r xp:50 skills:1     key:69c5664fdb
## The impact of portfolio weights on portfolio performance

The choice of portfolio weights matters.  


*** =instructions
- Complete the R script that runs a grid search to determine the portfolio weights for which the Sharpe ratio is the highest, assuming a zero risk free rate.  

*** =hint
hint

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
library(PerformanceAnalytics)
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
eq_prices <- get.hist.quote(instrument="SPY",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
bond_prices <- get.hist.quote(instrument="AGG",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
eq_prices <- eq_prices/as.numeric(eq_prices[1])
bond_prices <-  bond_prices/as.numeric(bond_prices[1])

newdates <- seq(as.Date(time(bond_prices ))[2], length=nrow(bond_prices ), by="1 month") - 2
eq_prices <- xts(eq_prices,newdates)
bond_prices <- xts(bond_prices,newdates)
prices <- cbind(eq_prices,bond_prices)
colnames(prices) <- c("equities","bonds")
# calculate returns
returns <- CalculateReturns(prices)
returns <- returns[(-1),]
returns_bonds <- returns$bonds
returns_equities <- returns$equities
```

*** =sample_code
```{r}
# returns_equities and returns_bonds are preloaded

# grid defining possible weights equities 
grid <- seq(0,1,0.01)
# initialize vector in which the Sharpe ratios will be stacked
vsharpe <- rep(NA,length(grid))
# initialize counter
i <- 1
#loop over the elements in the search grid
for(w in grid){
  # portfolio returns are monthly rebalanced
  preturns <- w*returns_equities+(1-w)*returns_bonds
  # compute the shapre ratio of preturns
  vsharpe[i] <- 
  # update counter  
  i <- 
}
# plot the obtained Sharpe ratios against the equity weights
plot(  ,   ,xlab="Equity weights",ylab="Ann. Sharpe ratio")
abline(v=grid[vsharpe==max(vsharpe)],lty=3)
```

*** =sct
```{r}
# PerformaneAnalytics is pre-loaded
# returns_equities and returns_bonds are preloaded
grid <- seq(0,1,0.01)
vsharpe <- rep(NA,length(grid))
i <- 1
for(w in grid){
  preturns <- w*returns_equities+(1-w)*returns_bonds
  vsharpe[i] <- SharpeRatio.annualized(preturns)
  #vsharpe[i] <- SharpeRatio.annualized(preturns)
  i <- i+1
}
plot(grid,vsharpe,xlab="weights",ylab="Ann. Sharpe ratio")
abline(v=grid[vsharpe==max(vsharpe)],lty=3)
```

--- type:VideoExercise lang:r xp:50 skills:1 key:bf1fc7dc803e342b4475c296bbebc2bab9b26f32
## The inputs in case of two assets

*** =video_link
//player.vimeo.com/video/108225030


--- type:NormalExercise lang:r xp:100 skills:1 key:b6a986b0e53bd119933fc39df94f21f2bf1e4318
## Interpreting correlation

Let us now compute the correlation between equity returns and bond returns. Just like volatilities, these correlations are dynamic. We thus need to distinguish between a static analysis computing correlations over the complete sample and a dynamic analysis computing correlations over the rolling sample. 

*** =instructions
- Plot the equity returns (`returns_equities`) against the bond returns (`returns_bonds`) using the function [chart.Scatter](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/chart.Scatter) with the bond returns on the x-asis. Do you see a relation? 
- Compute first the correlation between the variables `returns_equities` and `returns_bonds` using the standard function [cor](). 
- Repeat this using the function [chart.Correlation](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/chart.Correlation), with as argument the multivariate time series `returns`. 
- Commpute the rolling 24-month estimates of the bond-equity correlation using the function [chart.RollingCorrelation](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/chart.RollingCorrelation). 

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
library(PerformanceAnalytics)
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
eq_prices <- get.hist.quote(instrument="SPY",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
bond_prices <- get.hist.quote(instrument="AGG",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
eq_prices <- eq_prices/as.numeric(eq_prices[1])
bond_prices <-  bond_prices/as.numeric(bond_prices[1])
newdates <- seq(as.Date(time(bond_prices ))[2], length=nrow(bond_prices ), by="1 month") - 2
eq_prices <- xts(eq_prices,newdates)
bond_prices <- xts(bond_prices,newdates)
prices <- cbind(eq_prices,bond_prices)
colnames(prices) <- c("equities","bonds")
# load package
library(PerformanceAnalytics)
# calculate returns
returns <- CalculateReturns(prices)
returns <- returns[(-1),]
returns_bonds <- returns$bonds
returns_equities <- returns$equities
```

*** =sample_code
```{r}
# scatter plot

# calculation using cor

# merge returns_equities and returns_bonds into returns

# calculation and visualization using chart.Correlation

# rolling estimates using chart.RollingCorrelation

```

*** =solution
```{r}
# scatter plot
chart.Scatter(returns_equities,  returns_bonds)
# calculation using cor
cor(returns_equities,  returns_bonds)
# merge returns_equities and returns_bonds into returns
returns <- merge(returns_equities,returns_bonds)
# calculation and visualization using chart.Correlation
chart.Correlation(returns)
# rolling estimates using chart.RollingCorrelation
chart.RollingCorrelation(returns_equities, bonds,returns_equities,width=24)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:MultipleChoiceExercise lang:r xp:50 skills:1     key:f4f41f6b81
## The impact of correlation on performance.


We thus observed that  like the mean and volatility, the correlation is changing over time. This time-variation can have major effects on the portfolio volatility. In your workspace, a sensitivity plot is shown for the 60/40 and the 40/60 portfolio invested in equities and bonds over the sample. In the plot, the annualized standard deviation and volatilities are kept fixed at their sample estimates, while the correlation varies between -1 and 1. 

Consider an equally weighted portfolio of two assets with 10% and 20% volatility, respectively. Their correlation jumps from 0 to 0.5. Then the portfolio variance:    

*** =instructions
- Decreases with 50%
- Almost doubles
- Does not change  

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
library(PerformanceAnalytics)
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
eq_prices <- get.hist.quote(instrument="SPY",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
bond_prices <- get.hist.quote(instrument="AGG",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
eq_prices <- eq_prices/as.numeric(eq_prices[1])
bond_prices <-  bond_prices/as.numeric(bond_prices[1])
newdates <- seq(as.Date(time(bond_prices ))[2], length=nrow(bond_prices ), by="1 month") - 2
eq_prices <- xts(eq_prices,newdates)
bond_prices <- xts(bond_prices,newdates)
prices <- cbind(eq_prices,bond_prices)
colnames(prices) <- c("equities","bonds")
# load package
library(PerformanceAnalytics)
# calculate returns
returns <- CalculateReturns(prices)
returns <- returns[(-1),]
returns_bonds <- returns$bonds
returns_equities <- returns$equities

# standard deviations
sig1 <- sqrt(12)*sd(returns_equities)
sig2 <- sqrt(12)*sd(returns_bonds)
# corrleation grid
grid <- seq(-1,1,0.01)
# initializing solution vector
w <- 0.6
vpsd_6040 <- sqrt( w^2*sig1^2 + (1-w)^2*sig2^2 + 2*w*(1-w)*sig1*sig2*grid  )
w <- 0.4
vpsd_4060 = sqrt( w^2*sig1^2 + (1-w)^2*sig2^2 + 2*w*(1-w)*sig1*sig2*grid  )  
plot(grid,vpsd_6040,xlab="correlation",ylab="Ann. standard deviation",
      ylim = c(sig2,sig1),type="l")
lines(grid,vpsd_4060,col="red")
legend("topleft", legend=c("60/40 Equities-bonds","40/60 Equities-Bonds") , col=c("black","red") , lwd = 1 )


 # ((0.5^2*0.10^2+0.05^2*0.20^2+2*0.5*0.5*0.5)-(0.5^2*0.10^2+0.05^2*0.20^2))/(0.5^2*0.10^2+0.05^2*0.20^2)
```


*** =sct
```{r}
# sct code
test_mc(2) 
```

--- type:VideoExercise lang:r xp:50 skills:1 key:a2866e000af4e20577dc0d48d46765e2da1a7d9b
## The general case using matrix notation

*** =video_link
//player.vimeo.com/video/108225030

--- type:NormalExercise lang:r xp:100 skills:1  
## The asset allocation problem

A realistic portfolio is not only invested in US equities and US bonds. It also seeks for diversification by investing in real estate and commodities, among others. We therefore extend our investment opportunity consisting of the US equities ETF (SPY) and US bonds ETF (AGG) to include also a real estate investment trust (VEIEX) and an ETF tracking the GSCI commodities index (GSG).

The monthly returns on those investment are available as the variable `returns` in your workspace. 

*** =instructions
- Use the function [Return.portfolio](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/Return.portfolio) to compute the time series of returns for the monthly rebalanced portfolio that is 40% invested in equities, 40% in bonds, 10% in real estate and 10% in commodities. Call this new variable `preturns`.
- Merge `returns` and `preturns` and apply the function [table.AnnualizedReturns](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/table.AnnualizedReturns) to the merged object in order to compare the portfolio performance. 

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
library(PerformanceAnalytics)
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
eq_prices <- get.hist.quote(instrument="SPY",start=as.Date("2006-08-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
bond_prices <- get.hist.quote(instrument="AGG",start=as.Date("2006-08-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
re_prices <- get.hist.quote(instrument="VEIEX",start=as.Date("2006-08-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
comm_prices <- get.hist.quote(instrument="GSG",start=as.Date("2006-08-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
eq_prices <- eq_prices/as.numeric(eq_prices[1])
bond_prices <-  bond_prices/as.numeric(bond_prices[1])
re_prices <- re_prices/as.numeric(re_prices[1])
comm_prices <-  comm_prices/as.numeric(comm_prices[1])


### plot

prices <- cbind(eq_prices,bond_prices,re_prices,comm_prices)
returns <- CalculateReturns(prices)
returns <- returns[(-1),]
temp <- c( as.numeric(eq_prices), as.numeric(bond_prices),as.numeric(re_prices), as.numeric(comm_prices)   )
ylim <- c( min( temp ) , 1.4*max(temp) )
plot.zoo(eq_prices , main="Performance across asset classes",ylab="", xlab="",ylim=ylim)
lines(bond_prices,col="red")
lines(re_prices,col="blue")
lines(comm_prices,col="purple")
legend("topleft", legend=c("Equities (ticker: SPY)","Bonds (ticker: AGG)", "Real estate (ticker: VEIEX)",
                           "Commodities (ticker: GSG)") , col=c("black","red","blue","purple") , lwd = 1 ,ncol=1)

###
newdates <- seq(as.Date(time(bond_prices ))[2], length=nrow(bond_prices ), by="1 month") - 2
eq_prices <- xts(eq_prices,newdates)
bond_prices <- xts(bond_prices,newdates)
re_prices <- xts(re_prices,newdates)
comm_prices <- xts(comm_prices,newdates)
prices <- cbind(eq_prices,bond_prices,re_prices,comm_prices)
colnames(prices) <- c("equities","bonds","realestate","commodities")
# calculate returns
returns <- CalculateReturns(prices)
returns <- returns[(-1),]
```

*** =sample_code
```{r}
# sample code
weights <-  
preturns <- Return.portfolio(returns, weights,rebalance_on="months")
# merge
 
# compare annualized performance
table.AnnualizedReturns(returns_merged) 

```

*** =solution
```{r}
# sample code
weights <- c(0.4,0.4,0.1,0.1)
preturns <- Return.portfolio(returns, weights,rebalance_on="months")
# merge
returns_merged <- merge(returns,preturns)
# compare annualized performance
table.AnnualizedReturns(returns_merged)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```




--- type:NormalExercise lang:r xp:100 skills:1 key:080c6863fc
## Avoiding loops in calculating vector of estimates 

We could Use colMeans to compute the expected return vector. Then sum(weights*mu).

*** =instructions
- Compute the vector of average returns on those four investments using the R command `apply(returns,2,"mean")` and call this `vmeans`.
- Do the same to compute the vector standard deviations and call this `vsd`.
- Use the following R instructions to produce the scatter plot of average returns with respect to standard deviations:
`plot(vsd,vmeans,col="gray",xlim=c(0,0.10))
text( vsd ,  vmu ,  labels=colnames(returns), cex= 0.7)`
- Add a dashed horizontal line at `h=0` using [abline](http://www.rdocumentation.org/packages/graphics/functions/abline) by setting the argument `lty=3`
*** =hint
hint comes here

*** =pre_exercise_code
```{r}
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
library(PerformanceAnalytics)
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
eq_prices <- get.hist.quote(instrument="SPY",start=as.Date("2006-08-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
bond_prices <- get.hist.quote(instrument="AGG",start=as.Date("2006-08-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
re_prices <- get.hist.quote(instrument="VEIEX",start=as.Date("2006-08-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
comm_prices <- get.hist.quote(instrument="GSG",start=as.Date("2006-08-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")

newdates <- seq(as.Date(time(bond_prices ))[2], length=nrow(bond_prices ), by="1 month") - 2
eq_prices <- xts(eq_prices,newdates)
bond_prices <- xts(bond_prices,newdates)
re_prices <- xts(re_prices,newdates)
comm_prices <- xts(comm_prices,newdates)
prices <- cbind(eq_prices,bond_prices,re_prices,comm_prices)
colnames(prices) <- c("equities","bonds","realestate","commodities")
# calculate returns
returns <- CalculateReturns(prices)
returns <- returns[(-1),]
```

*** =sample_code
```{r}
# sample code
# vector of means
 
# vector of standard deviations

# scatter plot
 


```


*** =solution
```{r}
# vector of means
vmeans <- apply(returns,2,"mean")
# vector of standard deviations
vsd <- apply(returns,2,"sd")
# scatter plot
plot(vsd,vmeans,col="gray",xlim=c(0,0.10))
text( vsd , vmeans,  labels=colnames(returns), cex= 0.7)
abline(h=0,lty=3)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:NormalExercise lang:r xp:100 skills:1 key:9786a14448b7689cc1be071bd4f4408ceadd0ee7
## Portfolio volatility

Use cov to compute the sample covariance matrix. use of %*% or StdDev in PerformanceAnalytics. to see.

*** =instructions
- instruction 1
- instruction 2

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
```

*** =sample_code
```{r}
# sample code
```

*** =solution
```{r}
# solution code
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:VideoExercise lang:r xp:50 skills:1   key:ba9b12d382
## The portfolio's risk budget

*** =video_link
//player.vimeo.com/video/108225030

--- type:NormalExercise lang:r xp:100 skills:1 key:0931e83c3a402b2fb2d78958981928a327428e4d
## Portfolio risk attribution

compute the portfolio risk budget... barplot? function [StdDev](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/StdDev)

*** =instructions
- instruction 1
- instruction 2

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
```

*** =sample_code
```{r}
# sample code
```

*** =solution
```{r}
# solution code
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

