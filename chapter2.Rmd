---
title       : Analyzing performance 
description : The history of portfolio returns reveals valuable information about how much the investor can expect to gain or lose. This chapter introduces the R functionality to analyze the investment performance based on a statisical analysis of the portfolio returns. It includes graphical analysis and the calculation of performance statistics expressing average return, risk and risk-adjusted return over rolling estimation samples. 

--- type:VideoExercise lang:r xp:50 skills:1 key:c4b994ff53
## The different dimensions of portfolio performance

*** =video_link
//player.vimeo.com/video/108225030


--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:04255405f1b95fc9587c9350f29c6549b41cc79e
## Balancing risk and reward 

To the right you see three return distributions. The x-axis corresponds to the return of an asset, and the y-axis corresponds with the volatility.  Take a moment to look over these charts.

Notice that the distributions are all symmetric and the center of the distribution corresponds to the average return. 

Return distributions A and B have the same expected return. But distribution B has a higher volatility and therefore has a wider range of possible outcomes.This indicates that the risk of a large deviation from the mean return is higher for investing in B than when investing in A. Distribution C has the same level of volatility as distribution A but a higher return.

You're the type of investor who likes returns, but dislikes risks. Which distribution do you prefer?

*** =instructions
- Distribution A.
- Distribution B.
- Distribution C.

*** =hint
The typical investor wants to minimize volatility, and maximize return. 

*** =pre_exercise_code
```{r}
# pec
par(mfrow=c(3,1),mar=c(3,3,1,1),cex.axis=1.2)
vx = seq(-0.5,0.5,0.001)
vd_A <- dnorm(vx,mean=0.05,sd=0.10)
vd_B <- dnorm(vx,mean=0.05,sd=0.20)
vd_C <-dnorm(vx,mean=0.15,sd=0.10)
ylims = c(0,max(c(vd_A,vd_B,vd_C)))
plot( vx , vd_A,type="l",ylim=ylims,ylab="")
abline(v=0.05,lty=3)
text(x=-0.4,y=3,labels="Investment A")
#arrows(x0=-2*0.1,y0=dnorm(-2*0.1),x1=2*0.1,y1=dnorm( 2*0.1),lty=3)
#arrows(x0=2*0.1,y0=dnorm(-2*0.1),x1=-2*0.1,y1=dnorm( 2*0.1),lty=3)
plot( vx , vd_B,type="l",ylim=ylims,ylab="")
abline(v=0.05,lty=3)
text(x=-0.4,y=3,labels="Investment B")
plot( vx , vd_C,type="l",ylim=ylims,ylab="")
text(x=-0.4,y=3,labels="Investment C")
abline(v=0.15,lty=3)
```

*** =sct
```{r}
test_mc(3) # if 3 is the correct option.
```


--- type:NormalExercise lang:r xp:100 skills:1 key:07d324a8e6

## Exploring the monthly S&P 500 returns 

Let us now examine the monthly performance of the S&P 500 portfolio. 

A picture is worth a thousand word. This is why most analyses of performance start by studying the time series plot of the value of the investment. 


A plot of the S&P 500 for the period of 1986 until today is shown to your right. Each observation on this plot is an end-of-day value. This chart shows a number of booms and busts. Take a look at the chart, do you see why the 2000s are so often called the lost decade of investing?

These daily prices are available in your workspace as the variable `sp500`. This variable is an [xts](http://www.rdocumentation.org/packages/xts/) time series class. This means that each observation has a time-stamp. Your job is describe the monthly performance of the S&P 500. To do so, you will first need to aggregate daily price series to end-of-month prices. You will then calculate the monthly returns and visualize them in a table.

*** =instructions
- Use the function `to.monthly()` with the argument `sp500` and assign this to `sp500_monthly`
- Print the first six rows of `sp500_monthly`. Notice how aggregating the data has resulted in a table of four columns holding the opening, lowest, highest, and closing price of `sp500` for each month.
- Create `sp500_returns` using the function `Return.calculate` on `sp500_monthly` using the closing prices.
- Convert `sp500_returns` to a time-series using `xts()` and assign it to sp500_returns.
- Make the time series plot of the monthly returns.
- Use the function [table.CalendarReturns](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/table.CalendarReturns) in PerformanceAnalytics to present the monthly return data in the visually attractive format year x month. 

*** =hint
Remember that closing prices were printed in the 4th column of `sp500_monthly`. Use `sp500_monthly[ , 4]`

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="d")
library(PerformanceAnalytics)
sp500 <- xts(sp500)
#par(mfrow=c(2,1),mar=c(3,2,2,2),cex.axis=0.7)
plot.zoo(sp500 , main="Value of the S&P 500 portfolio",ylab="", xlab="")
#plot.zoo(sp500_returns , main="Monthly returns of the S&P 500 portfolio",ylab="", xlab="",type="h")
```

*** =sample_code
```{r}
# The package PerformanceAnalytics and xts, and the variable s500  are pre-loaded

# Convert sp500 to monthly returns


# Print the first six rows of sp500_monthly


# Create sp500_returns using Return.calculate using the closing prices


# Convert sp500_returns to a time-series


# Time series plot


# Produce the year x month table

```

*** =solution
```{r}
# The package PerformanceAnalytics and xts, and the variable s500  are pre-loaded

# Convert sp500 to monthly returns
sp500_monthly <- to.monthly(sp500)

# Print the first six rows of sp500_monthly
head(sp500_monthly)

# Create sp500_returns using Return.calculate using the closing prices
sp500_returns <- Return.calculate(sp500_monthly[ , 4])

# Convert sp500_returns to a time-series
sp500_returns <- xts(sp500_returns)

# Time series plot
plot.zoo(sp500_returns)

# Produce the year x month table
table.CalendarReturns(sp500_returns)
```

*** =sct
```{r}
# sct code
#1st instruction
test_object("sp500_monthly", incorrect_msg = "Did you call the correct function, `to.monthly`?")

#2nd instruction
test_student_typed("head(sp500_monthly)", not_typed_msg = "Did you preview the head of `sp500_monthly`?")

#3rd instruction
test_function("Return.calculate", "sp500_monthly[ , 4]")

#4th instruction
test_object("sp500_returns", incorrect_msg = "Did you convert `sp500_returns` to `xts`?")

#5th instruction
test_function("plot.zoo", "sp500_returns")

#6th instruction
test_function("table.CalendarReturns", "sp500_returns")

test_error()
success_msg("Well done!")
```

--- type:NormalExercise lang:r xp:100 skills:1 key:8c05172eb2

## The monthly mean and volatility  

In this exercise, you need to do a descriptive analysis of the mean and volatility of the monthly S&P 500 returns. These returns are available in your workspace as the variable `sp500_returns`. 


*** =instructions
- Compute the arithmetic and geometric mean value of the return series, using the functions [mean](http://www.rdocumentation.org/packages/base/functions/mean) and [mean.geometric](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/mean.geometric).
- Compute the standard deviation of the return series. 

*** =hint
The functions `mean` and `sd` are standard functions in R to estimate the mean and standard deviation.

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
library(PerformanceAnalytics)
sp500_returns <-  xts(Return.calculate(sp500))[-1]
names(sp500_returns) <- "sp500"
newdates <- seq(as.Date(as.yearmon(time(sp500_returns)))[2], length=nrow(sp500_returns), by="1 month") - 1
sp500_returns <- xts(sp500_returns,newdates)
```

*** =sample_code
```{r}
# sp500_returns is pre-loaded

# Compute the mean monthly returns 

# Compute the standard deviation


```

*** =solution
```{r}
# Compute the mean monthly returns 
mean(sp500_returns)
mean.geometric(sp500_returns)
# Compute the standard deviation
sd(sp500_returns)  
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```


--- type:VideoExercise lang:r xp:50 skills:1  key:5a642fd71c
## The (annualized) Sharpe ratio

*** =video_link
//player.vimeo.com/video/108225030

 
--- type:NormalExercise lang:r xp:100 skills:1   key:c14e2a1a3a
 
## Excess returns and the portfolio's Sharpe ratio  

Performance evaluation involves comparing with the alternative investment choices, such as investing in a (almost) risk free asset, such as the US Treasury Bill. Its return is called the risk free rate. This one-month  Tbill rate is available in your workspace as the variable `rf`.  The S&P 500 portfolio returns are still available as `sp500_returns`.  

*** =instructions
- Compute the annualized risk free using the compound interest formula and plot this series. 
- Compute the series of excess monthly portfolio return `sp500_excess` and compare its mean return with that of the raw monthly returns.
- Compute the corresponding monthly Sharpe ratio. 

*** =hint
If $y$ is the monthly interest rate. The yearly compounded intrest is given by $(1+y)^{12}$.

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
library(PerformanceAnalytics)
sp500_returns <-  xts(Return.calculate(sp500))[-1]
names(sp500_returns) <- "sp500"
newdates <- seq(as.Date(as.yearmon(time(sp500_returns)))[2], length=nrow(sp500_returns), by="1 month") - 1
sp500_returns <- xts(sp500_returns,newdates)

# The URL for the data.
ff.url <-"http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/F-F_Research_Data_Factors_TXT.zip"
f <- tempfile()
download.file(ff.url, f)
file.list <- unzip(f, list=TRUE)
ff <- read.fwf(unzip(f, files=as.character(file.list[1,1])), 
                             widths=c(8,8,8,8,10), header=FALSE,stringsAsFactors=FALSE, skip=5)[,c(1,5)]
ff <- ff[!is.na(ff[,1]),]
rowannual <- c(1:nrow(ff))[as.character(ff[,1])==" Annual "]
ff <- ff[1:(rowannual-1),]
rf <- as.numeric(ff[,2])/100
dates <- as.Date( paste0(trimws(ff[!is.na(rf),1]),"01"), format="%Y%m%d")-1
rf<- xts(rf,order.by=dates)
rf <- rf[time(sp500_returns )]
sp500_returns <- sp500_returns[time(rf )]
```


*** =sample_code
```{r}
# rf and sp500_returns are pre-loaded

# Annualized risk free rate

# Compute the series of excess portfolio returns 

# Compare the mean

# Compute the Sharpe ratio
  

```

*** =solution
```{r}
# Annualized risk free rate
plot.zoo( (1+rf)^12 )
# Compute the series of excess portfolio returns 
sp500_excess <- sp500_returns - rf
# Compare the mean
mean(sp500_excess)
mean(sp500_returns)
# Compute the Sharpe ratio
mean(sp500_excess)/sd(sp500_returns)  
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:NormalExercise lang:r xp:100 skills:1 key:ba9671b063deaba2de08399422178002f679c0f5

## Annualized mean and volatility

The mean and volatility of monthly returns corresponds to the average and standard deviation over a monthly investment horizon. Investors annualize those statistics by mutiplying the mean with 12, and the volatility with the square root of twelve. Compute the annualized mean and volatility of the portfolios.

*** =instructions
- Use the function [Return.annualized](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/Return.annualized) to compute the annualized mean of `sp500_returns`.
- Use the function [StdDev.annualized](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/StdDev.annualized) to compute the annualized standard deviation of `sp500_returns`.
- Assume the risk free rate is 0. What is the portfolio's Sharpe ratio?
- Obtain all the above results at one using the function   [table.AnnualizedReturns](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/table.AnnualizedReturns).
*** =hint
hint comes here

*** =pre_exercise_code
```{r}
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
library(PerformanceAnalytics)
sp500_returns <-  xts(Return.calculate(sp500))[-1]
names(sp500_returns) <- "sp500"
newdates <- seq(as.Date(as.yearmon(time(sp500_returns)))[2], length=nrow(sp500_returns), by="1 month") - 1
sp500_returns <- xts(sp500_returns,newdates)
```

*** =sample_code
```{r}
# PerformanceAnalytics and xts are pre-loaded
# sp500 is pre-loaded

# Annualized mean

# Annualized standard deviation

# Annualized Sharpe ratio

# All the above at once

```

*** =solution
```{r}
# Annualized mean
Return.annualized(sp500_returns)
# Annualized standard deviation
StdDev.annualized(sp500_returns)
# Annualized Sharpe
Return.annualized(sp500_returns)/StdDev.annualized(sp500_returns)
# All at once
table.AnnualizedReturns(sp500_returns)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

 

--- type:NormalExercise lang:r xp:100 skills:1 key:9d2eb4bc6c13e8cdabe71c739978050d8809058c
## Don't be fooled by randomness

The probabilistic view of portfolio performance evaluation considers that the time series of returns is driven by an underlying process. Performance evaluation then aims at inferring from the past returns relevant information about this return generation process. It tries to answer questions like: (i) what is on average the value of the return that will be generated by the process, and (ii) what will be the standard deviation of the returns? 

It is important to remember that, when trying to aswer those questions, we expose ourselves to estimation errors. We will never be able to know exactly the underlying process. We can only make a guess about it from the past returns.  This is the limitation of any estimation approach. It is almost sure that the estimates of the mean and volatility will be different from the true mean and standard deviation.

Familiarize now yourself with the uncertainty in estimation by drawing random samples from a normal distribution with mean of 5% and standard deviation of 10%, and how this uncertainty is reduced when the sample size grows.  

*** =instructions
-  Set the variable `returns` to the sample of 12 observations obtained by using the function `rnorm` to sample from the normal  distribution with mean 5% and standard deviation of 10%.  
- Compute the mean and standard deviation of the return series. 
- Repeat the first two instructions and see how different the numbers are for a different sample. 
- Repeat the first three instructions but for a sample of 60 observations.  
*** =hint


*** =pre_exercise_code
```{r}
# pec

```

*** =sample_code
```{r}
# Draw the random sample

# Compute the mean and standard deviation
  
# Repeat the above

# Repeat the above for a sample of 60 observations

```

*** =solution
```{r}
# Draw the random sample
returns <- rnorm(12,mean=0.05,sd=0.10)
# Compute the mean and standard deviation
mean(returns)
sd(returns)
# Repeat the above
returns <- rnorm(12,mean=0.05,sd=0.10)
mean(returns)
sd(returns)
# Repeat the above for a sample of 60 observations
returns <- rnorm(60,mean=0.05,sd=0.10)
mean(returns)
sd(returns)
returns <- rnorm(60,mean=0.05,sd=0.10)
mean(returns)
sd(returns)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:VideoExercise lang:r xp:50 skills:1 key:a481e8c772e346eb869ef192f4b17070be61961e
## Time-variation in portfolio performance


*** =video_link
//player.vimeo.com/video/108225030

--- type:NormalExercise lang:r xp:100 skills:1 key:737157d7421c452d9ab7cb48fc219403c4db82ff
## Rolling annualized mean and volatility

The function [chart.RollingPerformance](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/chart.RollingPerformance) makes it easy to visualize the rolling estimates of performance in R. Familiarize yourself first with the syntax of this function. It requires to specify the time series of portfolio returns (by setting the argument `R`), the length of the window (`width`) and the function used to compute the performance (argument `FUN`).

*** =instructions
- Print the annualized mean, standard deviation and Sharpe ratio of the monthly S&P 500 returns in `sp500_returns` obtained using the functions `Return.annualized`, `sd.annualized` and [SharpeRatio.annualized](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/SharpeRatio.annualized). For the latter, you can use the time series of monthly risk free rates in `rf`. Note that by default, geometric aggregation is used in anualizing the mean return. 
- Plot the rolling 12-month estimates of the annualized mean, and as a reference include the horizontal line showing the unconditional long run estimate of the annualized return. 
- Plot the rolling 12-month estimates of the annualized volatility of the S&P 500 returns, and as a reference include the horizontal line showing the unconditional long run estimate of the annualized return.  
- Plot the rolling 12-month estimates of the annualized Sharpe ratio of the S&P 500 returns. Include in the `chart.RollingPerformance` the additional argument that `Rf=rf`. As a reference include in the plot the horizontal line showing the unconditional long run estimate of the annualized return. 
- To see all three plots together, now use the function [charts.RollingPerformance](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/charts.RollingPerformance).
*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
library(PerformanceAnalytics)
sp500_returns <-  xts(Return.calculate(sp500))[-1]
names(sp500_returns) <- "sp500"
newdates <- seq(as.Date(as.yearmon(time(sp500_returns)))[2], length=nrow(sp500_returns), by="1 month") - 1
sp500_returns <- xts(sp500_returns,newdates)

# The URL for the data.
ff.url <-"http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/F-F_Research_Data_Factors_TXT.zip"
f <- tempfile()
download.file(ff.url, f)
file.list <- unzip(f, list=TRUE)
ff <- read.fwf(unzip(f, files=as.character(file.list[1,1])), 
                             widths=c(8,8,8,8,10), header=FALSE,stringsAsFactors=FALSE, skip=5)[,c(1,5)]
ff <- ff[!is.na(ff[,1]),]
rowannual <- c(1:nrow(ff))[as.character(ff[,1])==" Annual "]
ff <- ff[1:(rowannual-1),]
colnames(ff) <- c("date", "rf")
rf <- as.numeric(ff[,2])/100
dates <- as.Date( paste0(trimws(ff[!is.na(rf),1]),"01"), format="%Y%m%d")-1
rf<- xts(na.omit(rf),order.by=dates)

rf <- rf[time(sp500_returns )]
sp500_returns <- sp500_returns[time(rf )]
```

*** =sample_code
```{r}
# unconditional mean, vol and sharpe

# plotting the 12-month rolling annualized mean

# plotting the 12-month rolling annualized standard deviation

# plotting the 12-month rolling annualized Sharpe ratio

# all three plots together

```

*** =solution
```{r}
# unconditional mean and vol
Return.annualized(sp500_returns)
sd.annualized(sp500_returns)
SharpeRatio.annualized(sp500_returns,Rf=rf)
# plotting the 12-month rolling annualized mean
chart.RollingPerformance(R=sp500_returns , width=12,
                         FUN="Return.annualized" )
abline(h=Return.annualized(sp500_returns))
# plotting the 12-month rolling annualized standard deviation
chart.RollingPerformance(R=sp500_returns , width=12,
                         FUN="sd.annualized" )
abline(h=sd.annualized(sp500_returns))
# plotting the 12-month rolling annualized Sharpe ratio
chart.RollingPerformance(R=sp500_returns , width=12,
                         FUN="SharpeRatio.annualized",Rf=rf )
abline(h=SharpeRatio.annualized(sp500_returns,Rf=rf))
# all three plots together
charts.RollingPerformance(R=sp500_returns , width=12,Rf=rf )
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:2169b00c723410a1ee9217836b284bf4cdd7dc2c
## Effect of window length choice
I show two plots, one with rolling windows of 6 months and one with rolling windows of 24 months. Which one is more timely in terms of reacting to recent shocks?

*** =instructions
- Annualized volatility on rolling window of 6 months
- Annualized volatility on rolling window of 12 months

*** =hint
hint

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
library(PerformanceAnalytics)
sp500_returns <-  xts(Return.calculate(sp500))[-1]
names(sp500_returns) <- "sp500"
par(mfrow = c(2,1))
chart.RollingPerformance(R=sp500_returns , width=6,
                         FUN="sd.annualized",scale=12,main="6-months rolling annualized volatility S&P 500")
chart.RollingPerformance(R=sp500_returns , width=24,
                         FUN="sd.annualized",scale=12,main="12-months rolling annualized volatility S&P 500")
```

*** =sct
```{r}
test_mc(1) 
```

--- type:NormalExercise lang:r xp:100 skills:1 key:012c07fe20924387617cef2df90e9ac6458f6fa8
## Subperiod performance analysis and the function window 

We have now computed the performance measure on each possible sample of a fixed size that can be obtained by rolling through time. Often we are interested in the performance over one particular subwindow.  Obtaining a subset of a time series in R is straightforward using  the function [window](http://www.rdocumentation.org/packages/zoo/functions/window.zoo), having as first argument the return series that needs to be subset, then the start data and end date in the format `YYYY-MM-DD`.
In this exercise, we will be working with the daily S&P 500 returns, available as the variable `sp500_returns`.
 
*** =instructions
-  Define the `sp500_2008` and `sp500_2014` as the S&P 500 portfolio returns in 2008 and 2014 by subsetting the variable `sp500_returns`.
-  Plot the histograms of the returns in those two years, using the function [chart.Histogram](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/chart.Histogram), where the argument `methods`is set `c( "add.density", "add.normal")` to visualize the non-parameteric estimate of the denisty and the one obtained under the assumption of a normal distribution. 


*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="d")
plot.zoo(sp500)
library(PerformanceAnalytics)
sp500_returns <-  xts(Return.calculate(sp500))[-1]
names(sp500_returns) <- "sp500"
```

*** =sample_code
```{r}
# subsetting
sp500_2008 <- window(sp500_returns,start  = as.Date(" "), end  = as.Date(" ")  )
sp500_2014 <- 
# plotting
par( mfrow = c(1,2) , mar=c(3,2,2,2))
names(sp500_2008) <- "sp500_2008"
names(sp500_2014) <- "sp500_2014"
# histogram 2008

# histogram 2014


```

*** =solution
```{r}
# solution code
# subsetting
sp500_2008 <- window(sp500_returns,start  = as.Date("2008-01-01"), end  = as.Date("2008-12-31 ")  )
sp500_2014 <- window(sp500_returns,start  = as.Date("2014-01-01"), end  = as.Date("2014-12-31 ")  )
# plotting
par( mfrow = c(1,2) , mar=c(3,2,2,2))
names(sp500_2008) <- "sp500_2008"
names(sp500_2014) <- "sp500_2014"
# histogram 2008
chart.Histogram(sp500_2008,methods = c( "add.density", "add.normal"))
# histogram 2014
chart.Histogram(sp500_2014, methods = c( "add.density", "add.normal"))
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:VideoExercise lang:r xp:50 skills:1 key:1c105a499d956a288a91e9884d2f1765c20a025f
## The non-normality of the return distribution 


*** =video_link
//player.vimeo.com/video/108225030

--- type:NormalExercise lang:r xp:100 skills:1 key:dfd18e3152bb168fd30148d4b418df9383e2fa19
## Detecting non-normality using skewness and kurtosis

Performance evaluation is highly sensitive to the investment horizon. We already notice the time-variation and the properties of mean-reversion in returns and volatility. By the central limit theorem, it turns out that the longer the horizon over which a return is compute, the more normal its distribution is. This property of aggregational Gaussianity is illustrated in the plot environment showing comparing the histogram of the monthly and daily return of the S&P 500 over the period 1986 till current date. 

Let us verify whether the [skewness](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/skewness) and [kurtosis](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/kurtosis) statistics confirm this graphical analysis. By default, the [kurtosis](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/kurtosis)  reports the excess kurtosis (that is, the kurtosis minus three). 
 

*** =instructions
- Compute the skewness  of `sp500_daily` and `sp500_monthly`.
- Compute the   excess kurtois of `sp500_daily` and `sp500_monthly`.
    

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="d")
plot.zoo(sp500)
library(PerformanceAnalytics)
sp500_daily <-  xts(Return.calculate(sp500))[-1]
names(sp500_daily) <- "sp500_daily"

sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
plot.zoo(sp500)
library(PerformanceAnalytics)
sp500_monthly <-  xts(Return.calculate(sp500))[-1]
names(sp500_monthly) <- "sp500_monthly"
par( mfrow = c(1,2) , mar=c(3,2,2,2))
chart.Histogram(sp500_daily, methods = c( "add.density", "add.normal"))
chart.Histogram(sp500_monthly, methods = c( "add.density", "add.normal"))
```

*** =sample_code
```{r}
#  Compute the skewness 
  

# excess kurtois 


   

```

*** =solution
```{r}
#  Compute the skewness 
skewness(sp500_daily)
skewness(sp500_monthly)
# excess kurtois 
kurtosis(sp500_daily)
kurtosis(sp500_monthly)
 
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:NormalExercise lang:r xp:100 skills:1 key:774962285dd78c6a424e6a1eebc8c1cea5949cd3
## Downside risk measures

The standard deviation gives equal weight to positive and negative returns in calcuting the return variability. 
When the return distribution is asymmetric, investors use additional risk measures that focus on describing the potential losses. One such measure of downside risk is the [SemiDeviation](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/DownsideDeviation.html) computing the variability of the below-average return around the mean return.  

A further popular measure is the so-called "Value-at-Risk" at a pre-definity loss probability of e.g. 5%. Loosely speaking, it corresponds to the 5% quantile of the return distribution, such that a more negative return can only happen with a probability of 5%. The "expected shortfall"" at 5% is the average return when the return is below this 5% quantile. 

*** =instructions
- Compute the [SemiDeviation](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/SemiDeviation) of the monthly returns.
- Use the default implementation in the function [VaR](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/VaR.html) to estimate the 2.5% and 5% value-at-risk of a monthly investment in S&P 500 returns. 
- Use the default implementation in the function [ES](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/ES.html)  to estimate the 2.5% and 5% expected shortfall of a monthly investment in S&P 500 returns. 

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
plot.zoo(sp500)
library(PerformanceAnalytics)
sp500_monthly <-  xts(Return.calculate(sp500))[-1]
names(sp500_monthly) <- "sp500_monthly"
chart.Histogram(sp500_monthly, methods = c( "add.density", "add.normal"))
```

*** =sample_code
```
# compute the Sortino ratio

# compute value at risk

# compute expected shortfal

```

*** =solution
```{r}
# compute the Sortino ratio
SortinoRatio(sp500_monthly)
# compute value at risk
VaR(sp500_monthly,p=0.05)
VaR(sp500_monthly,p=0.025)
# compute expected shortfal
ES(sp500_monthly,p=0.05)
ES(sp500_monthly,p=0.025)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:NormalExercise lang:r xp:100 skills:1 key:20cda1434c7729ec212810fc6317b96b99c1b0ec
## Drawdowns due to buying high, selling low

The volatility, semideviation, value-at-risk and expected shortfall are risk measures that have in common that they describe the risk over one 1 period. They don't describe well the worst case risk of buying at the peak and selling at the trough. This risk can quantified by analyzing the portfolio's drawdowns, defined as the peak-to-trough decline in terms of cumulative return. The function [table.Drawdowns](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/table.Drawdowns) in PerformanceAnalytics reports describing by default the five largest drawdown episodes over the sample. 

*** =instructions
- Compute the five largest drawdowns of the S&P 500 using `sp500_monthly`.
- Use the function [chart.Drawdown](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/chart.Drawdown) to visualize the time-series evoluation of the drawdowns from each peak attained through time. 

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
sp500 <- get.hist.quote(instrument="^GSPC",start=as.Date("1985-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T,compression="m")
plot.zoo(sp500)
library(PerformanceAnalytics)
sp500_monthly <-  xts(Return.calculate(sp500))[-1]
names(sp500_monthly) <- "sp500_monthly"
```

*** =sample_code
```{r}
# Table of drawdowns

# Plot of drawdowns

```

*** =solution
```{r}
# Table of drawdowns
table.Drawdowns(sp500_monthly)
# Plot of drawdowns
chart.Drawdown(sp500_monthly)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

 

--- type:MultipleChoiceExercise lang:r xp:50 skills:1  key:bdf87df244
## Main take-aways on portfolio performance evaluation

Does your investment strategy work? This chapter has shown that the answer to this question requires, first of all, to analyzethe portfolio returns, and, secondly, that, often, there is no unique answer to this question.

In fact, very often it depends on how you look at the data. Do you consider the portfolio performance from inception, or only over the most recent 12 months? Do you use standard deviation as the risk measure, or rather the value-at-risk or expected shortfall? And, in terms of performance. Do you consider the average returns, or the returns in excess of some benchmark returns, such as the risk free rate? 

We only scratched at the surface of possible portfolio performance measures. Check the documentation in PerformanceAnalytics to find out which of the following statements is false. 

*** =instructions
- Like the [SortinoRatio](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/SortinoRatio), the [AdjustedSharpeRatio](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/AdjustedSharpeRatio) is an alternative for the Sharpe ratio that the non-normality of the return distribution into account when evaluating the reward received in terms of units of risk. 
- The larger the [TrackingError](http://www.rdocumentation.org/packages/PerformanceAnalytics/functions/TrackingError) of the portfolio returns compared to the returns of a benchmark strategy, the higher the risk that the returns on the portfolio strategy will deviate from the benchmark returns. 
- When the return distribution is symmetric, the probability of large negative returns is always small.  

*** =hint
hint

*** =pre_exercise_code
```{r}
library(PerformanceAnalytics)
```

*** =sct
```{r}
test_mc(1) 
```
