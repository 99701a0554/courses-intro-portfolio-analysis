---
title       : The building blocks 
description : Asset returns and portfolio weights; those are the building blocks of a portfolio return. In this chapter, you will first learn about computing portfolio weights in R. Next we will see how to combine portfolio weights and asset returns into the calculation of portfolio returns. The exercises involve both simple two-asset cases and a real-life portfolio invested in the 30 Dow Jones Industrial Average stocks. The final exercises consist in linking portfolio returns to the nominal portfolio value and doing a multi-period analysis.   

--- type:VideoExercise lang:r xp:50 skills:1
## Welcome to the course

*** =video_link
//player.vimeo.com/video/108225030

--- type:MultipleChoiceExercise lang:r xp:50 skills:1
## Risk and return

Which of the following statements is wrong:

*** =instructions
- Because most investors do not like risk, risky stocks sell on average at lower market prices
- Investment risk is static: it does not change over time
- If all assets have the same expected return and risk, an investor is better off by investing in a portfolio with many assets than a portfolio invested in just a few assets

*** =hint


*** =pre_exercise_code
```{r}
# pec
```

*** =sct
```{r}
test_mc(2) # if 2 is the correct option.
```

--- type:NormalExercise lang:r xp:100 skills:1
## Get a feel for the data

The choice of investment matters, even when the underlying risky assets are similar. As a first example, let us consider the stock price of the Coca Cola Company and the PepsiCo company from Januari 2003 till today. 

The time series plot shows you the value evolution of one dollar invested in each of them. 

*** =instructions
- The price series are available in the R environment as the variables `KO` and `PEP` 
- Define `KOvsPEP` as the ratio between `KO` and `PEP`
- Use `plot.zoo` to visualize the daily variation in this ratio 
- Note that, when the value of the ratio increases, `KO` outperforms `PEP` and vice versa
- Note also that, When the value of the ratio is larger than one, the cumulative performance of `KO` since Jan 2003 is higher than that of `PEP`. Thereofre, as a reference line, use `abline` to include a horizontal line at `h=1`.


*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
KO <- get.hist.quote(instrument="KO",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T)
PEP <- get.hist.quote(instrument="PEP",start=as.Date("2003-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T)

# 
KO <- KO/as.numeric(KO[1])
PEP <- PEP/as.numeric(PEP[1])

#
plot.zoo(KO, ylim=c( min(c(min(KO),min(PEP))) ,  max(c(max(KO),max(PEP))) ) , ylab="")
lines(PEP,col="red")
legend("topleft", legend=c("Coca-Cola","PepsiCo") , col=c("black","red") , lwd = 1 )
```

*** =sample_code
```{r}
KOvsPEP <- 
  
```

*** =solution
```{r}
KOvsPEP <- KO/PEP
plot.zoo(KOvsPEP)
abline(h=1)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:MultipleChoiceExercise lang:r xp:50 skills:1
## A first portfolio

A buy and hold investment versus daily rebalancing

The choice of investment matters, even when the underlying risky assets are similar. As a second example, let us now consider the stock price of Apple and Microsoft from Januari 2006 till today. The time series plot shows you the value evolution of one dollar invested in each of them. 

It is time to consider our first portfolio. The portfolio approach that we consider is to invest in January 2003, half of the investment budget in Apple and the other half in Microsoft. Since the portfolio weights will change, the investor has two choices. The first one is to be passive and not buy or trade anymore. This is called the a buy and hold investment strategy. Another possibility is to buy and trade at the close of each day in such a way that every day the portfolio is equally invested in the shares of Microsoft and the shares of Apple. We say that this portfolio is daily rebalanced.  

Which of the following statements is wrong

*** =instructions
- By investing in a portfolio of risky assets, the portfolio payoff will be in between the minimum and maximum of the payoff of the underlying risky assets.
- By investing in a portfolio of risky assets, the risk of the portfolio payoff will be less than the maximum risk of the underlying risky assets.
- An investor needs to have a lot of capital to be able to invest in a portfolio of many assets. 
- Because the prices of Microsoft and Apple have evolved differently, the investor who spent initially half of his wealth on Microsoft and Apple ends up with a portfolio that is no longer equally invested. 

*** =hint


*** =pre_exercise_code
```{r}
# pec
options(warn=-1)
library(tseries)# Its function get.hist.quote allows to download prices from Yahoo!Finance
library(xts) # Its function plot.zoo make simple, but attractive, time series plots
library(PerformanceAnalytics)
# download adjusted close prices (that is corrected for dividend payments and stock splits)
# dates have the format "YYYY-MM-DD"
AAPL <- get.hist.quote(instrument="AAPL",start=as.Date("2005-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T)
MSFT <- get.hist.quote(instrument="MSFT",start=as.Date("2005-12-31"),end=Sys.Date(),quote="AdjClose",quiet=T)
# 
AAPL <- AAPL/as.numeric(AAPL[1])
MSFT <- MSFT/as.numeric(MSFT[1])
mixed <- 0.5*AAPL + 0.5*MSFT

a <- CalculateReturns(AAPL, method="simple")
b <- CalculateReturns(MSFT, method="simple")
ab <- 0.5*(a+b)
ab[1] <- 0
ew <- cumprod(1+ab)
time(ew) <- time(AAPL)
#
plot.zoo(AAPL, ylim=c( min(c(min(AAPL),min(MSFT),min(ew),min(ab))) ,  max(c(max(AAPL),max(MSFT),max(ew),max(ab))) ) , ylab="", xlab="")
lines(MSFT,col="red")
lines(mixed,col="blue")
lines(ew,col="purple")
legend("topleft", legend=c("Apple","Microsoft","50-50 buy and hold","50-50 rebalanced") , col=c("black","red","blue","purple") , lwd = 1 )
```

*** =sct
```{r}
test_mc(3) # if 2 is the correct option.
```


--- type:VideoExercise lang:r xp:50 skills:1
## The investment decision in a portfolio context

*** =video_link
//player.vimeo.com/video/108225030


--- type:NormalExercise lang:r xp:100 skills:1
## Calculating portfolio weights when component values are given

An investor has  4000 USD invested in equities, 4000 USD in bonds and 2000 USD in commodities. Compute the weights as the proportion invested in each of those three assets. 

*** =instructions
- Define the vector `values` as the vector holding these three values.
- Print the vector `weights` as the vector `values` divided by the total value (obtained by summing over the component values using the function `sum`.

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
```

*** =sample_code
```{r}
# Define the vector values
values <- 
# Define the vector weights
weights <- 
# Print the resulting weights

```

*** =solution
```{r}
# Define the vector values
values <- c(4000,4000,2000)
# Define the vector weights
weights <- values/sum(values)
# Print the resulting weights
print(weights)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:MultipleChoiceExercise lang:r xp:50 skills:1
## Defining the weights of an equally weighted portfolio

The equally weighted portfolio is one of the most used portfolios. Suppose the portfolio is equally invested in $N$ assets. Let `N <- 100`. By testing this in the R console, find out which of the following commands does not define properly the weights for the equally-weighted portfolio.  

*** =instructions
- `weights <- rep(1,N)/N`
- `weights <- 1/N`
- `weights <- rep(1/N,N)`

*** =hint
The function `rep(arg1,arg2)` creates a vector in which `arg1` is replicated `arg2` times. 

*** =pre_exercise_code
```{r}
# pec
```

*** =sct
```{r}
test_mc(2) # if 2 is the correct option.
```

--- type:NormalExercise lang:r xp:100 skills:1
## Defining the weights of a market capitalization weighted portfolio

In a market capitalization weighted portfolio, the weight is given by the asset's market capitalization divided by the sum of the market capitalization of all assets. A typical example is the S&P 500 invested in the 500 largest companies listed on the US stock exchanges (NYSE, Nasdaq).  Note that dividing by the total value of the characteristic across all assets guarantees that the portfolio weights sum up to unity. 

As an exercise, inspect the distribution of market capitalization based weights when the portfolio is invested in 10 stocks and the market capitalizations are 5, 8, 9, 20, 25, 100, 100, 500, 700 and 2000 million USD. 

*** =instructions
- Define the vector `marketcaps` holding the market capitalization
- Define `weights`
- Print `summary(weights)` and make a histogram

*** =hint
A histogram in R can be made using the function [hist()](http://www.rdocumentation.org/packages/graphics/functions/hist).

*** =pre_exercise_code
```{r}
# pec
```

*** =sample_code
```{r}
# Define marketcaps
marketcaps <-  
# Compute the weights
weights <-
# Inspect summary statistics
 
```

*** =solution
```{r}
# Define marketcaps
marketcaps <- c(5, 8, 9, 20, 25, 100, 100, 500, 700, 2000)
# Compute the weights
weights <- marketcaps/sum(marketcaps)
# Inspect summary statistics 
summary(weights)
hist(weights)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```


--- type:VideoExercise lang:r xp:50 skills:1
## Portfolio returns are the weighted average of the individual returns


*** =video_link
//player.vimeo.com/video/108225030

--- type:NormalExercise lang:r xp:100 skills:1
## Calculation of portfolio returns

As first exercise, we verify that the portfolio return can be computed as the weighted average of the component returns. We do this for the simple case of three assets. 


*** =instructions
- Assume an investment in three assets, for which the initial values are given by `in.values <- c(1000,5000,2000)`.
- Suppose further that the value changes to 1100, 4500 and 3000, respectively. 
- Use the simple return definition to compute the vector of returns on the three component assets
- Use the portfolio return formula to compute the (simple) portfolio return
- Verify that the weighted average portfolio return  equals the percentage change in the total portfolio value.

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
```

*** =sample_code
```{r}
# Initial and final values of the assets
in.values <-  
fin.values <-  
# Compute simple returns 
returns <-  
# Compute portfolio return using the portfolio return formula
weights <-
preturns.vw <- 
# Verify that it matches with the percentage change in the portfolio value
( preturns.vw == (sum(fin.values)-sum(in.values))/sum(in.values) )
```

*** =solution
```{r}
# Initial and final values of the assets
in.values <- c(1000,5000,2000)
fin.values <- c(1100,4500,3000)
# Compute simple returns 
returns <- (fin.values-in.values)/in.values
# Compute portfolio return using the portfolio return formula
weights <- (fin.values - in.values)/in.values
preturns.vw <- sum(weights*returns)
# Verify that it matches with the percentage change in the portfolio value
( preturns.vw == (sum(fin.values)-sum(in.values))/sum(in.values) )
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```


--- type:MultipleChoiceExercise lang:r xp:50 skills:1
## Defining the portfolio returns for an equally weighted portfolio

Below you find three commands to compute the portfolio return of an equally weighted portfolio of `N <- 100` assets with return vector `returns`. By testing this in the R console, find out which of the following commands is wrong.

*** =instructions
- `preturn.ew <- mean( returns )`
- `preturn.ew <- sum( rep(1/N,N)*returns )`
- `preturn.ew <- rep( mean(returns),N )`

*** =hint
The portfolio return is a single number. 

*** =pre_exercise_code
```{r}
# pec
```

*** =sct
```{r}
test_mc(1) # if 2 is the correct option.
```





--- type:VideoExercise lang:r xp:50 skills:1
## A realistic portfolio case: Investing in the 30 DJIA stocks over 25 years with monthly rebalancing


*** =video_link
//player.vimeo.com/video/108225030

--- type:NormalExercise lang:r xp:100 skills:1
## Multiperiod returns

A $k$-period return can be easily computed from the one-period returns using the formula $\prod_{j=1}^k (1+R_1)(1+R_2)\cdots(1+R_k)-1$.


*** =instructions
- Define the vector returns with the following twelve monthly returns:  2.5%, 3%, -2.1%, 0.5%, 1%, -0.4%, 2%, 1%, 4%, -5%, 3% and 2%.
- Use `cumprod` to compute the total return over those 12 months.


*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
```

*** =sample_code
```{r}
returns <- 
  
```

*** =solution
```{r}
returns <- c(0.025 , 0.03 , -0.021 , 0.005 , 0.01 , -0.004, 0.02 , 0.01, 0.04 , -0.05, 0.03 , 0.02)
tail( cumprod(1+returns) , 1)-1
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:NormalExercise lang:r xp:100 skills:1
## The packages xts and PerformanceAnalytics
Up to now, we have done simple calculations in R. In the future we will need more complex functionality, which is available in the R packages [xts](http://www.rdocumentation.org/packages/xts/functions/xts-package) (for time series analysis in general) and [PerformanceAnalytics](http://www.rdocumentation.org/packages/performanceanalytics/functions/performanceanalytics-package) (for portfolio analysis in particular). Load this two packages in your R session.


*** =instructions
- Load the packages


*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
```

*** =sample_code
```{r}
# Load packages

```

*** =solution
```{r}
# Load packages
library(xts)
library(PerformanceAnalytics)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:NormalExercise lang:r xp:100 skills:1
## The multivariate time series of prices and returns 
Let us now inspect the xts file `prices` containing the end-of-month prices for the 30 Dow Jones Industrial Average constitutuents. 



*** =instructions
- Make use of the `head(prices,1)` and `tail(prices,1)` functions to print the first and last rows of `prices` and verify that the price data runs from December 1990 to December 2015. 
- Define `returns` as the multivariate return series using the R command `CalculateReturns(prices, method="simple")`
- Print the first 6 rows of returns and verify that the first row consists of NA's. 
- Redefine returns as the returns variable in which the first row has been removed.  

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
library(xts)
library(PerformanceAnalytics)
download.file("http://s3.amazonaws.com/assets.datacamp.com/course/portfolio-analysis/prices.rds", destfile="prices.rds")
prices<- readRDS("prices.rds")
```

*** =sample_code
```{r}
# First and last row
 
# Compute the simple returns based on the prices of DJIA stocks
returns <- 
# Remove the first row
returns <- 
```

*** =solution
```{r}
# First and last row
head(prices,1)
tail(prices,1)
# Compute the simple returns based on the prices of DJIA stocks
returns <- CalculateReturns(prices, method="simple")
# Remove the first row
returns <-returns[(-1),]
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:NormalExercise lang:r xp:100 skills:1
## Plotting and tabulating the time series of portfolio returns

Let us now consider the portfolio that invests equal amounts in each of the 30 stocks and the portfolio is rebalanced every month. The monthly portfolio return is therefore simply the average return over the month. It can be computed in R using the function `Return.portfolio`, which by default assumes equal investment
weights for each period. This leads to time series of monthly portfolio returns. An effective way to tabule monthly data over saveral years is to use the function `table.CalandarReturns()` in PerformanceAnalytics to present it in the format year x month.  Note the large portfolio losses during the burst of the internet bubble in 2002 and the financial crisis of 2009.  Finally, plot the resulting time series using the function `plot.zoo()`. Note that the time series is centered around zero and that the magnitude of the variations in return changes over time, because of time-varying volatility. 

*** =instructions
- define the variable `preturns` 
- make a month x year table of the `preturns`
- use `plot.zoo()` to make a time series plot of `preturns`

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
library(xts)
library(PerformanceAnalytics)
download.file("http://s3.amazonaws.com/assets.datacamp.com/course/portfolio-analysis/prices.rds", destfile="prices.rds")
prices<- readRDS("prices.rds") 
returns <- CalculateReturns(prices, method="simple")
returns <- returns[(-1),]
```

*** =sample_code
```{r}
# Define preturns
preturns <- 

# Tabulate those returns as year x month  

# Make the time series plot

```

*** =solution
```{r}
# Define preturns
preturns <- Return.portfolio( returns )
# Tabulate those returns as year x month  
table.CalendarReturns(preturns)  
# Make the time series plot
plot.zoo(preturns)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:NormalExercise lang:r xp:100 skills:1
## The evolution of portfolio value - The booms and busts of the stock market
The function `table.CalendarReturns` already reported in the last column the cumulative return performance per year. In order to obtain the cumulative investment value over a years, one needs to multiply the initial value value with $(1+R_1)*(1+R_2)*(1+R_3)*\ldots*(1+R_{12}),$ where $R_i$ is the return in month $i$. In R such a cumulative product is easily obtained using the function `cumprod(1+returns)` with returns the series of returns that needs to be compounded. Suppose the investor has $1 invested in the strategy of equally weighting all DJIA assets and monthly rebalancing. Plot the time series evolution of that investment over the full period available in the `preturns` time series vectors. 


*** =instructions
- Define `cumulative.value` as the cumulative product of the total returns 
- Plot this wealth evolution using the function `plot.zoo' and note the drawdowns during the market crashes.

*** =hint
hint comes here

*** =pre_exercise_code
```{r}
# pec
library(xts)
library(PerformanceAnalytics)
download.file("http://s3.amazonaws.com/assets.datacamp.com/course/portfolio-analysis/prices.rds", destfile="prices.rds")
prices<- readRDS("prices.rds")
returns <- CalculateReturns(prices, method="simple")
returns <- returns[(-1),]
preturns <- Return.portfolio( returns )
```

*** =sample_code
```{r}
# Define the time series holding the cumulative.value
cumulative.value <-    
# plot the wealth evolution

```

*** =solution
```{r}
# Define the time series holding the cumulative.value
cumulative.value <- cumprod(1+preturns)
# plot the wealth evolution
plot.zoo(cumulative.value)
```

*** =sct
```{r}
# sct code
success_msg("Well done!")
```

--- type:MultipleChoiceExercise lang:r xp:50 skills:1
## The asymmetric impact of gains and losses

It is important to be aware of the fact that a positive and negative return of the same magnitude do not compensate each other. Mathematically, this can be seen from the identity $(1+x)*(1-x)=1-x^2$, which is less than one. A 50% loss is thus not compensated by a 50% gain.  After a loss of 50%, what is the return needed to be at par again? 

*** =instructions
- 75%
- 100%
- 200%

*** =hint
hint

*** =pre_exercise_code
```{r}
# pec
```

*** =sct
```{r}
test_mc(2) # if 2 is the correct option.
```





